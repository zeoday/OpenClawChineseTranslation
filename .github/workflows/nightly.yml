# ============================================================
# OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - æœ€æ–°ç‰ˆï¼ˆNightlyï¼‰è‡ªåŠ¨æ„å»ºå·¥ä½œæµ
# æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ | https://qingchencloud.com/
# ============================================================
#
# è§¦å‘æ–¹å¼ï¼š
#   - æ¯å°æ—¶42åˆ†è‡ªåŠ¨è¿è¡Œ
#   - æ‰‹åŠ¨è§¦å‘
#
# ç‰ˆæœ¬è¯´æ˜ï¼š
#   - æœ€æ–°ç‰ˆ (@nightly)ï¼šæœ¬å·¥ä½œæµå‘å¸ƒï¼Œæ¯å°æ—¶è‡ªåŠ¨æ„å»ºï¼Œè¿½è¸ªä¸Šæ¸¸æœ€æ–°ä»£ç 
#   - ç¨³å®šç‰ˆ (@latest)ï¼šsync-and-release.yml å‘å¸ƒï¼Œæ‰‹åŠ¨æ‰“ tag è§¦å‘
#
# ä¼˜åŒ–ï¼š
#   - ä¸Šæ¸¸æ— å˜æ›´æ—¶è·³è¿‡æ„å»ºï¼ŒèŠ‚çœ Actions é…é¢
#   - è°ƒç”¨ build-core.yml å¤ç”¨å·¥ä½œæµï¼Œå‡å°‘ä»£ç é‡å¤
#
# ç”¨æˆ·å®‰è£…ï¼š
#   npm install -g @qingchencloud/openclaw-zh@nightly
# ============================================================

name: æœ€æ–°ç‰ˆæ„å»º (Nightly)

on:
  schedule:
    # æ¯å°æ—¶42åˆ†æ„å»ºï¼ˆé”™å³°é¿å…å†²çªï¼‰
    - cron: '42 * * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºï¼ˆè·³è¿‡ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'
        type: boolean

env:
  UPSTREAM_REPO: openclaw/openclaw
  NODE_VERSION: '22'

permissions:
  contents: write
  packages: write

jobs:
  # ==================== ä¸Šæ¸¸å˜æ›´æ£€æµ‹ ====================
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      upstream_version: ${{ steps.check.outputs.version }}
      upstream_sha: ${{ steps.check.outputs.sha }}
      nightly_version: ${{ steps.check.outputs.nightly_version }}
    
    steps:
      - name: æ£€æµ‹ä¸Šæ¸¸å˜æ›´
        id: check
        run: |
          # è·å–ä¸Šæ¸¸ npm ç‰ˆæœ¬
          UPSTREAM_VERSION=$(curl -s https://registry.npmjs.org/openclaw/latest | jq -r '.version')
          echo "ğŸ“¦ ä¸Šæ¸¸ç‰ˆæœ¬: $UPSTREAM_VERSION"
          
          # è·å–ä¸Šæ¸¸æœ€æ–° commit
          UPSTREAM_SHA=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/commits/main | jq -r '.sha' | cut -c1-7)
          echo "ğŸ“ ä¸Šæ¸¸ SHA: $UPSTREAM_SHA"
          
          # è·å–ä¸Šæ¬¡æ„å»ºè®°å½•çš„ SHAï¼ˆä» nightly release body ä¸­æå–ï¼‰
          LAST_SHA=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/nightly | jq -r '.body // ""' | grep -oP '<!-- upstream_sha:\K[a-f0-9]+' || echo "")
          echo "ğŸ“ ä¸Šæ¬¡ SHA: ${LAST_SHA:-æ— è®°å½•}"
          
          # åˆ¤æ–­æ˜¯å¦æœ‰å˜åŒ–
          if [ "$UPSTREAM_SHA" != "$LAST_SHA" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°ä¸Šæ¸¸å˜æ›´ï¼Œå°†æ‰§è¡Œæ„å»º"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ ä¸Šæ¸¸æ— å˜æ›´ï¼Œè·³è¿‡æ„å»º"
          fi
          
          # ç”Ÿæˆ nightly ç‰ˆæœ¬å·
          TIMESTAMP=$(date +%Y%m%d%H%M)
          NIGHTLY_VERSION="${UPSTREAM_VERSION}-nightly.${TIMESTAMP}"
          
          echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "sha=$UPSTREAM_SHA" >> $GITHUB_OUTPUT
          echo "nightly_version=$NIGHTLY_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Nightly ç‰ˆæœ¬: $NIGHTLY_VERSION"

  # ==================== è°ƒç”¨æ ¸å¿ƒæ„å»º ====================
  build:
    needs: check-upstream
    if: needs.check-upstream.outputs.has_changes == 'true' || github.event.inputs.force_build == 'true'
    uses: ./.github/workflows/build-core.yml
    with:
      version_type: nightly
      version: ${{ needs.check-upstream.outputs.nightly_version }}
      upstream_version: ${{ needs.check-upstream.outputs.upstream_version }}
      upstream_sha: ${{ needs.check-upstream.outputs.upstream_sha }}
    secrets: inherit

  # ==================== å‘å¸ƒåˆ° npm å’Œ Docker ====================
  publish:
    needs: [check-upstream, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: openclaw-build-nightly
          path: openclaw

      - name: éªŒè¯åŠŸèƒ½é¢æ¿æ³¨å…¥
        run: |
          echo "ğŸ“Š éªŒè¯ artifact ä¸­çš„åŠŸèƒ½é¢æ¿æ³¨å…¥..."
          # æ”¯æŒæ–°æ—§ä¸¤ç§ç›®å½•ç»“æ„
          JS_FILE=""
          if [ -f openclaw/dist/canvas-host/a2ui/a2ui.bundle.js ]; then
            JS_FILE="openclaw/dist/canvas-host/a2ui/a2ui.bundle.js"
            echo "ğŸ“ æ£€æµ‹åˆ°æ–°ç‰ˆç›®å½•ç»“æ„: canvas-host/a2ui"
          elif ls openclaw/dist/control-ui/assets/index-*.js 1>/dev/null 2>&1; then
            JS_FILE=$(ls openclaw/dist/control-ui/assets/index-*.js | head -1)
            echo "ğŸ“ æ£€æµ‹åˆ°æ—§ç‰ˆç›®å½•ç»“æ„: control-ui/assets"
          fi
          
          if [ -n "$JS_FILE" ]; then
            echo "JS æ–‡ä»¶: $JS_FILE"
            echo "æ–‡ä»¶å¤§å°: $(ls -la "$JS_FILE" | awk '{print $5}') bytes"
            PANEL_COUNT=$(grep -c 'initPanel' "$JS_FILE" || echo 0)
            echo "é¢æ¿ä»£ç å‡ºç°æ¬¡æ•°: $PANEL_COUNT"
            if [ "$PANEL_COUNT" -eq "0" ]; then
              echo "âš ï¸ è­¦å‘Š: artifact ä¸­æœªæ£€æµ‹åˆ°åŠŸèƒ½é¢æ¿ä»£ç ï¼"
            else
              echo "âœ… åŠŸèƒ½é¢æ¿ä»£ç å·²ç¡®è®¤å­˜åœ¨"
            fi
          else
            echo "âŒ æœªæ‰¾åˆ° JS æ–‡ä»¶"
            echo "ğŸ“ æŸ¥æ‰¾ dist ç›®å½•ç»“æ„..."
            find openclaw/dist -name "*.js" ! -path "*/node_modules/*" -type f 2>/dev/null | head -10
          fi

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: å‘å¸ƒåˆ° npm (nightly æ ‡ç­¾)
        working-directory: openclaw
        # ä½¿ç”¨ --ignore-scripts è·³è¿‡ prepack è„šæœ¬ï¼Œå› ä¸ºä»£ç å·²åœ¨ build job ä¸­æ„å»ºå®Œæˆ
        run: npm publish --access public --tag nightly --ignore-scripts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: åˆ é™¤æ—§çš„ nightly æ ‡ç­¾
        run: |
          git push origin :refs/tags/nightly || true
          echo "ğŸ—‘ï¸ å·²åˆ é™¤æ—§çš„ nightly æ ‡ç­¾"

      - name: åˆ›å»ºæ–°çš„ nightly æ ‡ç­¾
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -fa nightly -m "Nightly build ${{ needs.build.outputs.build_date }} ${{ needs.build.outputs.build_time }}"
          git push origin nightly --force
          echo "ğŸ·ï¸ å·²åˆ›å»º nightly æ ‡ç­¾"

      - name: åˆ›å»º/æ›´æ–° Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly
          name: "ğŸŒ™ Nightly Build - ${{ needs.build.outputs.build_date }} ${{ needs.build.outputs.build_time }}"
          prerelease: true
          body: |
            <!-- upstream_sha:${{ needs.check-upstream.outputs.upstream_sha }} -->
            
            ## ğŸŒ™ OpenClaw æ±‰åŒ–ç‰ˆ - æœ€æ–°ç‰ˆ (Nightly)
            
            > âš ï¸ **è­¦å‘Š**ï¼šæ­¤ä¸ºæ¯å°æ—¶è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œè¿½è¸ªä¸Šæ¸¸æœ€æ–°ä»£ç ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„æ›´æ”¹ã€‚
            > 
            > ğŸ”’ **éœ€è¦ç¨³å®šç‰ˆï¼Ÿ** è¯·å®‰è£… `@latest`ï¼š`npm install -g @qingchencloud/openclaw-zh@latest`
            
            **æ„å»ºæ—¶é—´**: ${{ needs.build.outputs.build_date }} ${{ needs.build.outputs.build_time }} (UTC)
            **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ needs.check-upstream.outputs.upstream_version }}
            **ä¸Šæ¸¸ SHA**: ${{ needs.check-upstream.outputs.upstream_sha }}
            **Nightly ç‰ˆæœ¬**: ${{ needs.check-upstream.outputs.nightly_version }}
            **å‘å¸ƒç±»å‹**: æœ€æ–°ç‰ˆ (Nightly) - æ¯å°æ—¶è‡ªåŠ¨æ„å»º
            
            ---
            
            ### ğŸ“Š æ±‰åŒ–ç»Ÿè®¡
            
            | æŒ‡æ ‡ | æ•°é‡ | çŠ¶æ€ |
            |------|------|------|
            | âœ… åº”ç”¨è§„åˆ™ | **${{ needs.build.outputs.applied }}** æ¡ | æˆåŠŸ |
            | â­ï¸ å·²å­˜åœ¨ | ${{ needs.build.outputs.existed }} æ¡ | è·³è¿‡ |
            | âš ï¸ æœªåŒ¹é… | ${{ needs.build.outputs.failed }} æ¡ | éœ€å…³æ³¨ |
            | ğŸ“ æ›¿æ¢æ“ä½œ | ${{ needs.build.outputs.files }} æ¬¡ | - |
            
            ---
            
            ### ğŸ“¦ å®‰è£… Nightly ç‰ˆæœ¬
            
            ```bash
            # å®‰è£… nightly ç‰ˆæœ¬
            npm install -g @qingchencloud/openclaw-zh@nightly
            
            # åˆ‡æ¢å›ç¨³å®šç‰ˆ
            npm install -g @qingchencloud/openclaw-zh@latest
            ```
            
            ---
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            
            - ğŸ”¥ å®˜ç½‘: https://openclaw.qt.cool/
            - ğŸ“– ç¨³å®šç‰ˆ: https://github.com/1186258278/OpenClawChineseTranslation/releases/latest
            - ğŸ“¦ npm: https://www.npmjs.com/package/@qingchencloud/openclaw-zh
            
            ---
            
            **æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸** | https://qingchencloud.com/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== Docker é•œåƒæ„å»ºä¸æ¨é€ ====================
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡ Docker å…ƒæ•°æ®
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclaw-zh
          tags: |
            type=raw,value=nightly
            type=raw,value=${{ needs.check-upstream.outputs.nightly_version }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./openclaw
          push: true
          tags: ${{ steps.docker_meta.outputs.tags }}
          labels: ${{ steps.docker_meta.outputs.labels }}
          # ä½¿ç”¨ Registry Cache - æ¯” GHA ç¼“å­˜æ›´ç¨³å®šï¼Œæ—  10GB é™åˆ¶
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/openclaw-zh:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/openclaw-zh:buildcache,mode=max
          platforms: linux/amd64,linux/arm64
        continue-on-error: true

      - name: è®¾ç½® Docker é•œåƒä¸ºå…¬å¼€
        run: |
          echo "ğŸ”“ è®¾ç½® Docker é•œåƒå¯è§æ€§ä¸º public..."
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/packages/container/openclaw-zh/versions \
            -d '{"visibility":"public"}' || true
        continue-on-error: true

      # ==================== Docker Hub é•œåƒï¼ˆå›½å†…åŠ é€Ÿï¼‰ ====================
      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: æ¨é€åˆ° Docker Hubï¼ˆå›½å†…åŠ é€Ÿï¼‰
        uses: docker/build-push-action@v5
        with:
          context: ./openclaw
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USER }}/openclaw-zh:nightly
            ${{ secrets.DOCKERHUB_USER }}/openclaw-zh:${{ needs.check-upstream.outputs.nightly_version }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/openclaw-zh:buildcache
          platforms: linux/amd64,linux/arm64
        continue-on-error: true

      - name: æ„å»ºæ‘˜è¦
        run: |
          echo "## ğŸŒ™ Nightly æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»ºæ—¶é—´ | ${{ needs.build.outputs.build_date }} ${{ needs.build.outputs.build_time }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ç‰ˆæœ¬ | ${{ needs.check-upstream.outputs.upstream_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ SHA | ${{ needs.check-upstream.outputs.upstream_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nightly ç‰ˆæœ¬ | ${{ needs.check-upstream.outputs.nightly_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åº”ç”¨è§„åˆ™ | ${{ needs.build.outputs.applied }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æœªåŒ¹é…è§„åˆ™ | ${{ needs.build.outputs.failed }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ å®‰è£…æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**npm**: \`npm install -g @qingchencloud/openclaw-zh@nightly\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker (ghcr.io)**: \`docker pull ghcr.io/${{ github.repository_owner }}/openclaw-zh:nightly\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Hub (å›½å†…åŠ é€Ÿ)**: \`docker pull ${{ github.repository_owner }}/openclaw-zh:nightly\`" >> $GITHUB_STEP_SUMMARY

  # ==================== æ— å˜æ›´æ—¶çš„æ‘˜è¦ ====================
  skip-summary:
    needs: check-upstream
    if: needs.check-upstream.outputs.has_changes == 'false' && github.event.inputs.force_build != 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: æ— å˜æ›´æ‘˜è¦
        run: |
          echo "## â­ï¸ Nightly æ„å»ºå·²è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä¸Šæ¸¸ä»£ç æ— å˜æ›´ï¼Œè·³è¿‡æœ¬æ¬¡æ„å»ºã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ç‰ˆæœ¬ | ${{ needs.check-upstream.outputs.upstream_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ SHA | ${{ needs.check-upstream.outputs.upstream_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚éœ€å¼ºåˆ¶æ„å»ºï¼Œè¯·ä½¿ç”¨ã€ŒRun workflowã€å¹¶å‹¾é€‰ã€Œå¼ºåˆ¶æ„å»ºã€é€‰é¡¹ã€‚" >> $GITHUB_STEP_SUMMARY
