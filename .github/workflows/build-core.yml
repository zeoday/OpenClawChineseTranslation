# ============================================================
# OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - æ ¸å¿ƒæ„å»ºé€»è¾‘ï¼ˆå¯å¤ç”¨å·¥ä½œæµï¼‰
# æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ | https://qingchencloud.com/
# ============================================================
#
# æ­¤å·¥ä½œæµè¢« nightly.yml å’Œ sync-and-release.yml è°ƒç”¨
# åŒ…å«ï¼šå…‹éš†ä¸Šæ¸¸ â†’ åº”ç”¨æ±‰åŒ– â†’ æ„å»º â†’ ä¿®å¤å›¾æ ‡ â†’ æ³¨å…¥é¢æ¿
# ============================================================

name: æ ¸å¿ƒæ„å»ºé€»è¾‘

on:
  workflow_call:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹: nightly æˆ– stable'
        required: true
        type: string
      version:
        description: 'ç‰ˆæœ¬å·'
        required: true
        type: string
      upstream_version:
        description: 'ä¸Šæ¸¸ç‰ˆæœ¬å·'
        required: true
        type: string
      upstream_sha:
        description: 'ä¸Šæ¸¸ commit SHAï¼ˆå¯é€‰ï¼Œç”¨äºè®°å½•ï¼‰'
        required: false
        type: string
        default: ''
    outputs:
      applied:
        description: 'åº”ç”¨çš„ç¿»è¯‘è§„åˆ™æ•°'
        value: ${{ jobs.build.outputs.applied }}
      existed:
        description: 'å·²å­˜åœ¨çš„è§„åˆ™æ•°'
        value: ${{ jobs.build.outputs.existed }}
      failed:
        description: 'æœªåŒ¹é…çš„è§„åˆ™æ•°'
        value: ${{ jobs.build.outputs.failed }}
      files:
        description: 'æ›¿æ¢æ“ä½œæ¬¡æ•°'
        value: ${{ jobs.build.outputs.files }}
      build_date:
        description: 'æ„å»ºæ—¥æœŸ'
        value: ${{ jobs.build.outputs.build_date }}
      build_time:
        description: 'æ„å»ºæ—¶é—´'
        value: ${{ jobs.build.outputs.build_time }}

env:
  UPSTREAM_REPO: openclaw/openclaw
  NODE_VERSION: '22'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      applied: ${{ steps.apply.outputs.applied }}
      existed: ${{ steps.apply.outputs.existed }}
      failed: ${{ steps.apply.outputs.failed }}
      files: ${{ steps.apply.outputs.files }}
      build_date: ${{ steps.prepare.outputs.build_date }}
      build_time: ${{ steps.prepare.outputs.build_time }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: é…ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: å…‹éš†ä¸Šæ¸¸ä»£ç 
        run: |
          git clone --depth 1 https://github.com/${{ env.UPSTREAM_REPO }}.git openclaw
          cd openclaw
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "âœ… ä¸Šæ¸¸ä»£ç å·²å…‹éš† (commit: $COMMIT_SHA)"

      - name: åº”ç”¨æ±‰åŒ–è¡¥ä¸
        id: apply
        run: |
          # è¿è¡Œæ±‰åŒ–å¹¶æ•è·è¾“å‡º
          OUTPUT=$(node cli/index.mjs apply --verbose 2>&1) || true
          echo "$OUTPUT"
          
          # æå–ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½¿ç”¨ sed æ›¿ä»£ grep -Pï¼Œå…¼å®¹æ€§æ›´å¥½ï¼‰
          APPLIED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*åº”ç”¨ \([0-9]*\).*/\1/' || echo "0")
          EXISTED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*å·²å­˜åœ¨ \([0-9]*\).*/\1/' || echo "0")
          FAILED=$(echo "$OUTPUT" | grep "æ€»è®¡:" | sed 's/.*æœªæ‰¾åˆ° \([0-9]*\).*/\1/' || echo "0")
          FILES_COUNT=$(echo "$OUTPUT" | grep -c "æ›¿æ¢:" || echo "0")
          
          # å¦‚æœæå–å¤±è´¥ï¼Œè®¾ç½®é»˜è®¤å€¼
          [ -z "$APPLIED" ] && APPLIED="0"
          [ -z "$EXISTED" ] && EXISTED="0"
          [ -z "$FAILED" ] && FAILED="0"
          
          echo "applied=$APPLIED" >> $GITHUB_OUTPUT
          echo "existed=$EXISTED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "files=$FILES_COUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“Š æ±‰åŒ–ç»Ÿè®¡ï¼š"
          echo "   âœ… åº”ç”¨è§„åˆ™: $APPLIED æ¡"
          echo "   â­ï¸ å·²å­˜åœ¨: $EXISTED æ¡"
          echo "   âš ï¸ æœªåŒ¹é…: $FAILED æ¡"
          echo "   ğŸ“ æ›¿æ¢æ“ä½œ: $FILES_COUNT æ¬¡"

      - name: éªŒè¯æ±‰åŒ–ç»“æœ
        run: |
          node cli/index.mjs verify || true
          echo "âœ… æ±‰åŒ–éªŒè¯å®Œæˆ"

      - name: æ„å»º OpenClaw
        working-directory: openclaw
        run: |
          pnpm install
          pnpm run build
          echo "âœ… æ ¸å¿ƒæ„å»ºå®Œæˆ"
          
      - name: æ„å»º Dashboard UI
        working-directory: openclaw
        run: |
          pnpm ui:build
          echo "âœ… Dashboard UI æ„å»ºå®Œæˆ"
          ls -la dist/control-ui/ || echo "âŒ control-ui ç›®å½•ä¸å­˜åœ¨"
          ls -la dist/control-ui/assets/ || echo "âŒ assets ç›®å½•ä¸å­˜åœ¨"

      - name: æ³¨å…¥åŠŸèƒ½é¢æ¿
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ“ ç›®å½•ç»“æ„:"
          ls -la
          echo ""
          echo "ğŸ“ openclaw/dist/ å†…å®¹:"
          ls -la openclaw/dist/ || echo "âŒ openclaw/dist/ ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ“ openclaw/dist/control-ui/ å†…å®¹:"
          ls -la openclaw/dist/control-ui/ || echo "âŒ control-ui ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ“ openclaw/dist/control-ui/assets/ å†…å®¹:"
          ls -la openclaw/dist/control-ui/assets/ || echo "âŒ assets ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ” æœç´¢æ‰€æœ‰åŒ…å« index.html çš„ç›®å½•:"
          find openclaw/dist -name "index.html" -type f 2>/dev/null | head -10
          echo ""
          echo "ğŸ” æœç´¢æ‰€æœ‰ assets ç›®å½• (æ’é™¤ node_modules):"
          find openclaw/dist -name "assets" -type d ! -path "*/node_modules/*" 2>/dev/null | head -10
          echo ""
          echo "ğŸ“ canvas-host/a2ui ç›®å½•å†…å®¹ (å¦‚æœå­˜åœ¨):"
          ls -la openclaw/dist/canvas-host/a2ui/ 2>/dev/null || echo "âŒ ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "ğŸ” æœç´¢æ‰€æœ‰ .js æ–‡ä»¶ (æ’é™¤ node_modules):"
          find openclaw/dist -name "*.js" ! -path "*/node_modules/*" -type f 2>/dev/null | grep -E "(index|main|app)" | head -10
          echo ""
          echo "ğŸ¦ å¼€å§‹æ³¨å…¥åŠŸèƒ½é¢æ¿..."
          python3 scripts/inject_panel.py
          echo ""
          echo "ğŸ“Š æ³¨å…¥åæ£€æŸ¥:"
          # æ”¯æŒæ–°æ—§ä¸¤ç§ç›®å½•ç»“æ„
          JS_FILE=""
          if [ -f openclaw/dist/canvas-host/a2ui/a2ui.bundle.js ]; then
            JS_FILE="openclaw/dist/canvas-host/a2ui/a2ui.bundle.js"
          elif ls openclaw/dist/control-ui/assets/index-*.js 1>/dev/null 2>&1; then
            JS_FILE=$(ls openclaw/dist/control-ui/assets/index-*.js | head -1)
          fi
          
          if [ -n "$JS_FILE" ]; then
            echo "JS æ–‡ä»¶: $JS_FILE"
            echo "æ–‡ä»¶å¤§å°: $(ls -la "$JS_FILE" | awk '{print $5}') bytes"
            PANEL_COUNT=$(grep -c 'initPanel' "$JS_FILE" || echo 0)
            echo "æ˜¯å¦åŒ…å«é¢æ¿ä»£ç : $PANEL_COUNT å¤„"
            if [ "$PANEL_COUNT" -eq "0" ]; then
              echo "âŒ é”™è¯¯: é¢æ¿ä»£ç æœªæ³¨å…¥æˆåŠŸï¼"
            else
              echo "âœ… é¢æ¿ä»£ç æ³¨å…¥æˆåŠŸ"
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°ä¸» JS æ–‡ä»¶"
          fi
          echo "âœ… åŠŸèƒ½é¢æ¿æ³¨å…¥æ­¥éª¤å®Œæˆ"

      - name: å‡†å¤‡ç‰ˆæœ¬ä¿¡æ¯
        id: prepare
        run: |
          VERSION="${{ inputs.version }}"
          VERSION_TYPE="${{ inputs.version_type }}"
          
          echo "build_date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "build_time=$(date +%H:%M)" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION ($VERSION_TYPE)"
          
          # æ›´æ–° package.json
          cd openclaw
          npm version $VERSION --no-git-tag-version --allow-same-version || true
          
          # ä¿®æ”¹åŒ…ä¿¡æ¯
          if [ "$VERSION_TYPE" = "nightly" ]; then
            jq '.description = "OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ (Nightly) - æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸"' package.json > tmp.json && mv tmp.json package.json
          else
            jq '.description = "OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆï¼ˆç¨³å®šç‰ˆï¼‰- æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸"' package.json > tmp.json && mv tmp.json package.json
          fi
          
          jq '.name = "@qingchencloud/openclaw-zh"' package.json > tmp.json && mv tmp.json package.json
          
          # ä½¿ç”¨ä¸­æ–‡ README
          cp ../README.md ./README.md

      - name: å‡†å¤‡ Docker æ„å»º
        run: |
          # å¤åˆ¶ Dockerfile å’Œ .dockerignore åˆ°æ„å»ºç›®å½•
          cp Dockerfile openclaw/Dockerfile
          cp .dockerignore openclaw/.dockerignore 2>/dev/null || true
          
          # éªŒè¯æ„å»ºäº§ç‰©å­˜åœ¨
          echo "ğŸ“¦ æ£€æŸ¥æ„å»ºäº§ç‰©..."
          ls -la openclaw/
          ls -la openclaw/dist/ || echo "âš ï¸ dist/ ç›®å½•ä¸å­˜åœ¨"
          ls -la openclaw/node_modules/ | head -20 || echo "âš ï¸ node_modules/ ç›®å½•ä¸å­˜åœ¨"
          
          # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          if [ ! -d "openclaw/dist" ]; then
            echo "âŒ é”™è¯¯ï¼šdist/ ç›®å½•ä¸å­˜åœ¨ï¼ŒDocker æ„å»ºå°†å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… Docker æ„å»ºå‡†å¤‡å®Œæˆ"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-build-${{ inputs.version_type }}
          path: openclaw/
          retention-days: 1
